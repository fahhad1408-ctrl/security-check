<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --primary: #00d1ff; --bg: #050505; --card: #111; --danger: #ff4d4d; --safe: #00ff88; }
        body { background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; margin: 0; padding: 15px; text-align: center; }
        .radar-box { height: 150px; display: flex; align-items: center; justify-content: center; position: relative; }
        .circle { width: 80px; height: 80px; border: 2px solid var(--primary); border-radius: 50%; border-top-color: transparent; animation: spin 0.8s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .report { background: var(--card); border-radius: 15px; padding: 20px; display: none; text-align: right; border: 1px solid #222; }
        .item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #222; font-size: 14px; }
        .val { color: var(--primary); font-weight: bold; }
        .verdict { margin-top: 20px; padding: 15px; border-radius: 12px; font-weight: bold; font-size: 18px; }
        .v-safe { border: 1px solid var(--safe); color: var(--safe); background: rgba(0,255,136,0.05); }
        .v-danger { border: 1px solid var(--danger); color: var(--danger); background: rgba(255,77,77,0.05); }
    </style>
</head>
<body>

    <h2 id="status-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…...</h2>
    
    <div id="loader" class="radar-box">
        <div class="circle"></div>
    </div>

    <div id="report" class="report">
        <div class="item"><span>Ø§Ù„Ø¯ÙˆÙ„Ø©:</span><span id="country" class="val">..</span></div>
        <div class="item"><span>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</span><span id="city" class="val">..</span></div>
        <div class="item"><span>Ø§Ù„Ø­ÙŠ/Ø§Ù„Ø´Ø§Ø±Ø¹:</span><span id="neighborhood" class="val">..</span></div>
        <div class="item"><span>Ù…Ø²ÙˆØ¯ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª:</span><span id="isp" class="val">..</span></div>
        <div class="item"><span>ÙƒØ´Ù Ø§Ù„Ù€ VPN:</span><span id="vpn-stat" class="val">..</span></div>
        <div class="item"><span>ØªÙ„Ø§Ø¹Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹:</span><span id="mock-stat" class="val">..</span></div>
        
        <div id="verdict" class="verdict">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª..</div>
        <button onclick="location.reload()" style="width:100%; padding:12px; margin-top:15px; background:#222; color:#888; border:none; border-radius:10px;">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙØ­Øµ</button>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    async function startAudit() {
        let issues = 0;
        let coords = null;

        // 1. Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ (GPS) Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø£Ù†Ù‡ Ø§Ù„Ø£ØµØ¯Ù‚
        navigator.geolocation.getCurrentPosition(async (pos) => {
            coords = pos.coords;
            
            // Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­ÙŠ ÙˆØ§Ù„Ø´Ø§Ø±Ø¹ Ù…Ù† Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù€ GPS
            try {
                const geoRes = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${coords.latitude}&lon=${coords.longitude}&accept-language=ar`);
                const geoData = await geoRes.json();
                const addr = geoData.address;
                document.getElementById('neighborhood').innerText = addr.suburb || addr.neighbourhood || addr.road || "ØºÙŠØ± Ù…ØªØ§Ø­";
            } catch(e) { document.getElementById('neighborhood').innerText = "ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ¯"; }

            // 2. ÙØ­Øµ Ø§Ù„Ù€ IP ÙˆØ§Ù„Ù€ VPN
            try {
                const ipRes = await fetch('https://ipapi.co/json/');
                const ipData = await ipRes.json();
                
                document.getElementById('country').innerText = ipData.country_name;
                document.getElementById('city').innerText = ipData.city;
                document.getElementById('isp').innerText = ipData.org;

                // Ù‚Ø§Ø±Ù† Ø¨ÙŠÙ† Ø¯ÙˆÙ„Ø© Ø§Ù„Ù€ IP ÙˆØ¯ÙˆÙ„Ø© Ø§Ù„Ù€ GPS (Ø£Ù‡Ù… ÙØ­Øµ Ù„Ù„Ù€ VPN)
                const osTZ = Intl.DateTimeFormat().resolvedOptions().timeZone;
                if (!osTZ.includes(ipData.timezone.split('/')[1])) {
                    document.getElementById('vpn-stat').innerText = "Ù†Ø´Ø· ğŸš©";
                    document.getElementById('vpn-stat').style.color = "var(--danger)";
                    issues += 2;
                } else {
                    document.getElementById('vpn-stat').innerText = "ØºÙŠØ± Ù†Ø´Ø· âœ…";
                }

            } catch(e) { 
                document.getElementById('vpn-stat').innerText = "ÙØ´Ù„ Ø§Ù„ÙØ­Øµ (Ø§ØªØµØ§Ù„ Ù…Ø´Ø¨ÙˆÙ‡)";
                issues++;
            }

            // 3. ÙØ­Øµ Ø§Ù„ØªÙ„Ø§Ø¹Ø¨ Ø¨Ø§Ù„Ù€ GPS (Ø§Ù„Ø¯Ù‚Ø© ÙˆØ§Ù„Ø§Ø±ØªÙØ§Ø¹)
            if (coords.accuracy < 1 || coords.altitude === 0) {
                document.getElementById('mock-stat').innerText = "Ù…ÙƒØªØ´Ù ğŸš©";
                issues += 2;
            } else {
                document.getElementById('mock-stat').innerText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ âœ…";
            }

            finalize(issues);
        }, () => {
            document.getElementById('status-text').innerText = "ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹";
        }, { enableHighAccuracy: true });
    }

    function finalize(issues) {
        document.getElementById('loader').style.display = 'none';
        document.getElementById('report').style.display = 'block';
        document.getElementById('status-text').innerText = "ØªÙ‚Ø±ÙŠØ± Ø£Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²";
        
        const v = document.getElementById('verdict');
        if (issues === 0) {
            v.innerText = "Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¢Ù…Ù† ØªÙ…Ø§Ù…Ø§Ù‹ âœ…";
            v.className = "verdict-box v-safe";
            tg.HapticFeedback.notificationOccurred('success');
        } else {
            v.innerText = "ØªØ­Ø°ÙŠØ±: ØªÙ… Ø§ÙƒØªØ´Ø§Ù ØªÙ„Ø§Ø¹Ø¨ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ğŸš©";
            v.className = "verdict-box v-danger";
            tg.HapticFeedback.notificationOccurred('error');
        }
    }

    setTimeout(startAudit, 1000);
</script>
</body>
</html>
