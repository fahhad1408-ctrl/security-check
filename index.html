<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --primary: #00d1ff; --bg: #050505; --card: #121212; --danger: #ff4d4d; --safe: #00ff88; --warning: #ffcc00; }
        body { background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; margin: 0; padding: 15px; }
        #start-screen { position: fixed; inset: 0; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; text-align: center; }
        .btn { background: var(--primary); color: #000; border: none; padding: 16px 45px; border-radius: 50px; font-weight: bold; font-size: 18px; cursor: pointer; }
        .report { background: var(--card); border-radius: 15px; padding: 15px; border: 1px solid #222; margin-top: 10px; display: none; }
        .item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #1f1f1f; font-size: 13px; }
        .val { color: var(--primary); font-weight: bold; }
        .verdict { margin-top: 20px; padding: 15px; border-radius: 12px; text-align: center; font-weight: bold; border: 1px solid #333; }
        .loader { width: 50px; height: 50px; border: 3px solid #222; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="start-screen">
    <div style="font-size: 60px; margin-bottom: 10px;">ğŸ›¡ï¸</div>
    <h2>Ù†Ø¸Ø§Ù… Ø§Ù„ÙØ­Øµ Ø§Ù„Ø£Ù…Ù†ÙŠ V4.0</h2>
    <p style="color: #666; margin-bottom: 30px;">Ø§Ø¶ØºØ· Ù„Ù„Ø¨Ø¯Ø¡ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆØ§Ù„Ø´Ø¨ÙƒØ©</p>
    <button class="btn" onclick="runAudit()">Ø§Ø¨Ø¯Ø£ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø¢Ù†</button>
</div>

<div id="main-ui" style="display:none;">
    <h3 id="status-text" style="text-align:center;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</h3>
    <div id="loading" class="loader"></div>

    <div id="report" class="report">
        <div style="color:#555; font-size:11px; margin-bottom:10px;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø¬Ù†Ø§Ø¦ÙŠ:</div>
        <div class="item"><span>Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø²:</span><span id="d_type" class="val">..</span></div>
        <div class="item"><span>Ø§Ù„Ø¯ÙˆÙ„Ø© (Ø§Ù„Ø´Ø¨ÙƒØ©):</span><span id="d_country" class="val">..</span></div>
        <div class="item"><span>Ù…Ø²ÙˆØ¯ Ø§Ù„Ø®Ø¯Ù…Ø©:</span><span id="d_isp" class="val">..</span></div>
        <div class="item"><span>Ø§Ù„Ù…ÙˆÙ‚Ø¹ (GPS):</span><span id="d_loc" class="val">..</span></div>
        <div class="item"><span>ÙƒØ´Ù Ø§Ù„Ù€ VPN:</span><span id="d_vpn" class="val">..</span></div>
        <div class="item"><span>ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø·ÙˆØ±:</span><span id="d_dev" class="val">..</span></div>
        
        <div id="verdict-box" class="verdict">Ø¬Ø§Ø±ÙŠ Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø­ÙƒÙ…...</div>
        <button onclick="location.reload()" style="width:100%; padding:12px; margin-top:15px; background:none; border:1px solid #333; color:#555; border-radius:10px;">Ø¥Ø¹Ø§Ø¯Ø© ÙØ­Øµ</button>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    async function runAudit() {
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('main-ui').style.display = 'block';
        document.getElementById('loading').style.display = 'block';
        tg.HapticFeedback.impactOccurred('heavy');

        let riskScore = 0;
        let vpnDetected = false;

        // 1. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ© (Ù†Ø¸Ø§Ù… Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©)
        try {
            const apiUrls = ['https://ipapi.co/json/', 'https://ipinfo.io/json?token=7ba0a7c473729e'];
            let data = null;
            for(let url of apiUrls) {
                try {
                    const res = await fetch(url);
                    data = await res.json();
                    if(data.country_name || data.country) break;
                } catch(e) {}
            }

            if(data) {
                document.getElementById('d_country').innerText = data.country_name || data.country;
                document.getElementById('d_isp').innerText = (data.org || data.company || "Ø´Ø±ÙƒØ© Ø®Ø§ØµØ©").split(' ').slice(0,2).join(' ');
                
                const offset = new Date().getTimezoneOffset();
                if(offset !== -180 || (data.country_code !== 'SA' && data.country !== 'SA')) {
                    vpnDetected = true;
                    riskScore += 2;
                }
            }
        } catch(e) { riskScore += 0.5; }

        // 2. ÙØ­Øµ Ø§Ù„Ù€ GPS ÙˆØ§Ù„Ø­Ø³Ø§Ø³Ø§Øª
        navigator.geolocation.getCurrentPosition(async (pos) => {
            document.getElementById('d_vpn').innerText = vpnDetected ? "Ù†Ø´Ø· ğŸš©" : "ØºÙŠØ± Ù†Ø´Ø· âœ…";
            document.getElementById('d_type').innerText = /iPhone|iPad/i.test(navigator.userAgent) ? "Apple iPhone" : "Android Device";
            document.getElementById('d_dev').innerText = navigator.webdriver ? "Ù…ÙØ¹Ù„ ğŸš©" : "Ù…ØºÙ„Ù‚ âœ…";
            if(navigator.webdriver) riskScore += 2;

            try {
                const geo = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&accept-language=ar`);
                const gData = await geo.json();
                document.getElementById('d_loc').innerText = gData.address.suburb || gData.address.city || "Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚";
            } catch(e) { document.getElementById('d_loc').innerText = "ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯"; }

            finish(riskScore);
        }, () => finish(riskScore + 3), { enableHighAccuracy: true });
    }

    function finish(score) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('report').style.display = 'block';
        document.getElementById('status-text').innerText = "Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù…Ù†ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ";
        
        const box = document.getElementById('verdict-box');
        if(score === 0) {
            box.innerText = "Ø§Ù„Ø¬Ù‡Ø§Ø² Ø³Ù„ÙŠÙ… ØªÙ…Ø§Ù…Ø§Ù‹ âœ…";
            box.style.color = "var(--safe)"; box.style.borderColor = "var(--safe)";
            tg.HapticFeedback.notificationOccurred('success');
        } else if(score < 3) {
            box.innerText = "ØªØ­Ø°ÙŠØ±: Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ù…Ù†ÙŠØ© Ù…ØªÙˆØ³Ø·Ø© âš ï¸";
            box.style.color = "var(--warning)"; box.style.borderColor = "var(--warning)";
            tg.HapticFeedback.notificationOccurred('warning');
        } else {
            box.innerText = "Ø®Ø·Ø±: ØªÙ… ÙƒØ´Ù Ø£Ø¯ÙˆØ§Øª ØªÙ„Ø§Ø¹Ø¨ ğŸš«";
            box.style.color = "var(--danger)"; box.style.borderColor = "var(--danger)";
            tg.HapticFeedback.notificationOccurred('error');
        }
    }
</script>
</body>
</html>
